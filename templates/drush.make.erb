<%-
  # normalize the hashes and unwrap the shorthand notions
  normalized_modules = @modules.inject({}) do |result, (key, value)|
    result[key] = value.is_a?(String) ? { 'version' => value } : value
    result
  end
  normalized_themes = @themes.inject({}) do |result, (key, value)|
    result[key] = value.is_a?(String) ? { 'version' => value } : value
    result
  end
  normalized_libraries = @libraries.inject({}) do |result, (key, value)|
    result[key] = value.is_a?(String) ? { 'version' => value } : value
    result
  end
-%>

; Managed by Puppet

; API
api = 2

; Core
core = <%= @core_major_version %>.x
projects[drupal][version] = <%= @core_version %>

; Modules
<%- normalized_modules.sort.each do |module_name, module_data| -%>
projects[<%= module_name %>][type] = module
    <%- module_data.sort.each do |data_key, data_value| -%>
        <%- if data_key == 'version' -%>
projects[<%= module_name %>][version] = <%= data_value %>
        <%- elsif data_key == 'patch' -%>
            <%- data_value.each do |patch_file| -%>
projects[<%= module_name %>][patch][] = <%= patch_file %>
            <%- end -%>
        <%- else -%>
projects[<%= module_name %>][download][<%= data_key %>] = <%= data_value %>
        <%- end -%>
    <%- end -%>
<%- end -%>

; Themes
<%- normalized_themes.sort.each do |module_name, module_data| -%>
projects[<%= module_name %>][type] = theme
    <%- module_data.sort.each do |data_key, data_value| -%>
        <%- if data_key == 'version' -%>
projects[<%= module_name %>][version] = <%= data_value %>
        <%- elsif data_key == 'patch' -%>
            <%- data_value.each do |patch_file| -%>
projects[<%= module_name %>][patch][] = <%= patch_file %>
            <%- end -%>
        <%- else -%>
projects[<%= module_name %>][download][<%= data_key %>] = <%= data_value %>
        <%- end -%>
    <%- end -%>
<%- end -%>

; Libraries
<%- normalized_libraries.sort.each do |library_name, library_data| -%>
projects[<%= library_name %>][type] = theme
    <%- library_data.sort.each do |data_key, data_value| -%>
        <%- if data_key == 'version' -%>
libraries[<%= library_name %>][version] = <%= data_value %>
        <%- elsif data_key == 'destination' -%>
libraries[<%= library_name %>][destination] = <%= data_value %>
        <%- elsif data_key == 'patch' -%>
            <%- data_value.each do |patch_file| -%>
libraries[<%= library_name %>][patch][] = <%= patch_file %>
            <%- end -%>
        <%- else -%>
libraries[<%= library_name %>][download][<%= data_key %>] = <%= data_value %>
        <%- end -%>
    <%- end -%>
<%- end -%>
